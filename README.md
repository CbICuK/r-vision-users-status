# R-Vision users status

Отображение активных статусов пользователей системы.
Данные собираются с веб-сервера. Лог содержит только ip-адреса польщователей

## Сервисы:

### 1. Log reader

Считывает лог веб-сервера в реальном времени. Формат лога задается через регулярное выражение в файле config.py

```python
LOG_PARSER_REGEX=r'(::ffff:|)(?P<ip>\d+\.\d+\.\d+\.\d+)\s-\s-\s\[(?P<time>[^\]]+)\]\s"(?P<method>.*?)\s(?P<path>.*?)\s(?P<protocol>.*?)"\s(?P<status>\d+)\s(?P<size>\d+)\s"(?P<referer>.*?)"\s"(?P<user_agent>.*?)"'
```

### 2. Status page

Веб страница для отображения статусов.
Переход статусов по цветам зеленый -> оранжевый -> серый.
От зеленого к оранжевому за 1 час.
От оранжевого к серому за 23 часа.
Пользователи хранятся в базе 24 часа.

### 3. Redis

База для хранения актуальной информации.

## Подготовка

Предполагается размещение на том же сервере где установлен контейнер с nginx. Поэтому docker и docker-compose должны быть уже устаонвлены в системе.

## Установка

> [!IMPORTANT]
> Т.к. текцщему приложению необходим доступ к контейнерам, находящися в сети SMP r-vison, то обязательно сначала нужно запустить приложение и только после этого добавлять новый эндпоинт в веб-сервер r-vision.
> В противном случае контейнер с nginx не запустится.

1. Разместить файлы репозитория в одном каталоге, например `/opt/r-vision-users-status/`
   Можно просто склонировать репозиторий

```bash
git clone https://github.com/CbICuK/r-vision-users-status.git
```

2. Перейти в каталог и запустить скрипт установки

```bash
cd /opt/r-vision-users-status/
sudo ./install.sh
```

Скрипт сам выполнит необходимые действия в правильном порядке.

> [!IMPORTANT]
> Скрипт установки перезапускает веб-сервер r-vision. Возможно кратковременное прерывание работы веб-интерфейса.

3. Проверить, что контейнер с nginx запустился

```bash
docker logs -n 10 $(docker ps -f label="com.docker.compose.service"="nginx" -f name="r-vision" --format '{{.Names}}')
```

## Использование

Страница с монторингом доступна по ссылке `http(s)://<FQDN вашего сервера>/online/`

## Example

![](https://github.com/CbICuK/r-vision-users-status/blob/main/example.gif?raw=true)
